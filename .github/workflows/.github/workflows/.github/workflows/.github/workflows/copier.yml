name: Telegram Copier ‚Äì Elite 24/7 Loop

on:
  workflow_dispatch:

permissions:
  actions: write      # REQUIRED for restart
  contents: read

concurrency:
  group: telegram-copier
  cancel-in-progress: false

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 350   # safety below 360

    steps:

      # =========================
      # CHECKOUT
      # =========================
      - name: ‚¨áÔ∏è Checkout repository
        uses: actions/checkout@v4

      # =========================
      # PYTHON SETUP
      # =========================
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # =========================
      # CACHE (optional speed boost)
      # =========================
      - name: ‚ö° Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            pip-${{ runner.os }}

      # =========================
      # INSTALL DEPS
      # =========================
      - name: üì¶ Install dependencies
        run: |
          pip install --upgrade pip
          pip install telethon

      # =========================
      # RESTORE STATE
      # =========================
      - name: ‚ôªÔ∏è Restore bot state
        uses: actions/download-artifact@v4
        with:
          name: bot-state
          path: .
        continue-on-error: true

      # =========================
      # VALIDATE SECRETS
      # =========================
      - name: üîê Validate secrets
        env:
          API_ID: ${{ secrets.API_ID }}
          API_HASH: ${{ secrets.API_HASH }}
          SESSION_STRING: ${{ secrets.SESSION_STRING }}
        run: |
          if [ -z "$API_ID" ] || [ -z "$API_HASH" ] || [ -z "$SESSION_STRING" ]; then
            echo "‚ùå Missing required secrets"
            exit 1
          fi
          echo "‚úÖ Secrets OK"

      # =========================
      # RUN BOT
      # =========================
      - name: üöÄ Run Elite Copier
        env:
          API_ID: ${{ secrets.API_ID }}
          API_HASH: ${{ secrets.API_HASH }}
          SESSION_STRING: ${{ secrets.SESSION_STRING }}
        run: |
          echo "‚ö° Starting Copier..."
          python copier.py

      # =========================
      # SAVE STATE
      # =========================
      - name: üíæ Save bot state
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bot-state
          path: |
            forwarded_hashes.txt
            copier.log
        retention-days: 1

      # =========================
      # CONTROLLED SELF-RESTART
      # =========================
      - name: üîÅ Self-restart workflow
        if: always()
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          WORKFLOW_FILE: copier.yml   # üëà MUST match filename
        run: |
          echo "‚ôªÔ∏è Triggering next run..."

          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_PAT" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/$WORKFLOW_FILE/dispatches \
            -d '{"ref":"main"}'

      # =========================
      # FAILSAFE
      # =========================
      - name: ‚ö† Restart fallback delay
        if: failure()
        run: |
          echo "‚ö† Restart API failed ‚Äî delaying"
          sleep 30
