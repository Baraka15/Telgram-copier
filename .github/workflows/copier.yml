name: Telegram Copier

on:
  schedule:
    # Every 5 minutes
    # Only weekdays (Monâ€“Fri)
    # Only 02:00 â†’ 20:59 UTC
    - cron: "*/5 2-20 * * 1-5"

  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest

    # âœ… Prevent overlapping executions
    concurrency:
      group: telegram-copier
      cancel-in-progress: true

    # âœ… Hard timeout safety (prevents stuck Telethon jobs)
    timeout-minutes: 3

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"   # âœ… Speeds up dependency installs

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install telethon

      # âœ… Persistent state cache (REAL FIX)
      - name: â™»ï¸ Restore state
        uses: actions/cache@v4
        with:
          path: last_seen.json
          key: lastseen-${{ github.ref }}
          restore-keys: |
            lastseen-

      - name: ğŸš€ Run copier
        run: python copier.py
        env:
          API_ID: ${{ secrets.API_ID }}
          API_HASH: ${{ secrets.API_HASH }}
          SESSION_STRING: ${{ secrets.SESSION_STRING }}

      # âœ… Save updated state
      - name: ğŸ’¾ Save state
        uses: actions/cache@v4
        with:
          path: last_seen.json
          key: lastseen-${{ github.ref }}
