name: Telegram Copier Realtime Engine

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"
  push:
    branches:
      - main

permissions:
  contents: read
  actions: write
  checks: write

env:
  PYTHON_VERSION: "3.11"
  RUNTIME_DIR: "runtime"
  LOG_FILE: "copier.log"
  DB_FILE: "copier.db"
  MAX_RETRIES: 5
  HEALTH_CHECK_URL: "https://example.com/health"

jobs:

  # ==========================================
  # BUILD + VALIDATION
  # ==========================================
  build-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        id: cache-pip
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run unit tests
        continue-on-error: true
        run: |
          pip install pytest
          pytest tests/ || echo "‚ö†Ô∏è Tests failed"

      - name: Lint code
        continue-on-error: true
        run: |
          pip install flake8 black
          flake8 . || echo "‚ö†Ô∏è Flake8 issues"
          black --check . || echo "‚ö†Ô∏è Black formatting issues"

      - name: Upload dependency cache
        uses: actions/upload-artifact@v4
        with:
          name: build-deps
          path: |
            ~/.cache/pip
            requirements.txt


  # ==========================================
  # MAIN COPIER ENGINE
  # ==========================================
  run-copier:
    needs: build-test
    runs-on: ubuntu-latest
    timeout-minutes: 350

    strategy:
      matrix:
        shard: [1, 2]
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download dependency cache
        uses: actions/download-artifact@v4
        with:
          name: build-deps
          path: ~/.cache/pip

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Prepare runtime storage
        run: |
          echo "üöß Preparing runtime directory"
          mkdir -p $RUNTIME_DIR
          touch $RUNTIME_DIR/$LOG_FILE
          touch $RUNTIME_DIR/$DB_FILE
          ls -la $RUNTIME_DIR

      - name: Restore previous runtime state
        uses: actions/download-artifact@v4
        with:
          name: runtime-state
          path: ${{ env.RUNTIME_DIR }}
        continue-on-error: true

      - name: Start Copier Engine (Shard ${{ matrix.shard }})
        env:
          API_ID: ${{ secrets.API_ID }}
          API_HASH: ${{ secrets.API_HASH }}
          SESSION_STRING: ${{ secrets.SESSION_STRING }}
          SHARD_ID: ${{ matrix.shard }}
        run: |
          echo "üöÄ Starting Copier Engine (Shard $SHARD_ID)"

          curl -X POST "$HEALTH_CHECK_URL" \
            -d "status=starting&shard=$SHARD_ID" \
            || echo "‚ö†Ô∏è Health check failed"

          retry_count=0

          while [ $retry_count -lt $MAX_RETRIES ]
          do
            echo "‚ñ∂ Attempt $retry_count"

            python copier.py >> "$RUNTIME_DIR/$LOG_FILE" 2>&1 && break

            retry_count=$((retry_count+1))
            echo "‚ö†Ô∏è Crash detected ‚Üí retrying in 10s"
            sleep 10
          done

          if [ $retry_count -eq $MAX_RETRIES ]; then
            echo "‚ùå Max retries reached"
            exit 1
          fi

      - name: Completion Health Check
        if: always()
        run: |
          STATUS="${{ job.status }}"
          curl -X POST "$HEALTH_CHECK_URL" \
            -d "status=$STATUS&shard=${{ matrix.shard }}" \
            || echo "‚ö†Ô∏è Health check failed"

      - name: Upload runtime state
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: runtime-state
          path: ${{ env.RUNTIME_DIR }}/*
          retention-days: 7

      - name: Notify Slack on failure
        if: failure() && secrets.SLACK_WEBHOOK != ''
        uses: ravsamhq/notify-slack-action@v2
        continue-on-error: true
        with:
          status: ${{ job.status }}
          notification_title: "Copier Engine Failed (Shard ${{ matrix.shard }})"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}


  # ==========================================
  # POST-RUN ANALYSIS
  # ==========================================
  post-run:
    needs: run-copier
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Download runtime state
        uses: actions/download-artifact@v4
        with:
          name: runtime-state
          path: ${{ env.RUNTIME_DIR }}
        continue-on-error: true

      - name: Analyze logs
        run: |
          echo "üìä Log Analysis"

          if [ -f "$RUNTIME_DIR/$LOG_FILE" ]; then
            echo "Success count:"
            grep -c "‚úÖ" "$RUNTIME_DIR/$LOG_FILE" || true

            echo "Warning count:"
            grep -c "‚ö†" "$RUNTIME_DIR/$LOG_FILE" || true
          else
            echo "‚ö†Ô∏è No log file found"
          fi

      - name: Backup DB to S3
        if: secrets.AWS_ACCESS_KEY_ID != ''
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          S3_BUCKET: "my-backup-bucket"
        run: |
          pip install awscli

          if [ -f "$RUNTIME_DIR/$DB_FILE" ]; then
            aws s3 cp "$RUNTIME_DIR/$DB_FILE" \
              "s3://$S3_BUCKET/backups/$(date +%Y-%m-%d)-$DB_FILE" \
              || echo "‚ö†Ô∏è S3 upload failed"
          else
            echo "‚ö†Ô∏è No DB file found"
          fi

      - name: Generate workflow report
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let content = "No logs available";

            try {
              content = fs.readFileSync(process.env.RUNTIME_DIR + "/" + process.env.LOG_FILE, "utf8");
            } catch (e) {}

            core.summary
              .addHeading('Copier Engine Report')
              .addCodeBlock(content, 'log')
              .write();
