name: Telegram Copier Realtime Engine

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"
  push:
    branches:
      - main

permissions:
  contents: read

env:
  PYTHON_VERSION: "3.11"
  RUNTIME_DIR: runtime
  LOG_FILE: copier.log
  DB_FILE: advanced_copier.db
  MAX_RETRIES: 5

jobs:

  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-${{ env.PYTHON_VERSION }}

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

  run-copier:
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 350

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Prepare runtime
        run: |
          mkdir -p ${{ env.RUNTIME_DIR }}
          touch ${{ env.RUNTIME_DIR }}/${{ env.LOG_FILE }}

      - name: Run Copier Engine
        env:
          API_ID: ${{ secrets.API_ID }}
          API_HASH: ${{ secrets.API_HASH }}
          SESSION_STRING: ${{ secrets.SESSION_STRING }}
        run: |
          retry_count=0
          while [ $retry_count -lt ${{ env.MAX_RETRIES }} ]
          do
            echo "üöÄ Starting Copier (Attempt $retry_count)"
            python copier.py >> ${{ env.RUNTIME_DIR }}/${{ env.LOG_FILE }} 2>&1 && break

            echo "‚ö† Crash detected ‚Üí restarting in 10s"
            retry_count=$((retry_count+1))
            sleep 10
          done

          if [ $retry_count -eq ${{ env.MAX_RETRIES }} ]; then
            echo "‚ùå Max retries reached"
            exit 1
          fi

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: runtime-logs
          path: ${{ env.RUNTIME_DIR }}/${{ env.LOG_FILE }}
